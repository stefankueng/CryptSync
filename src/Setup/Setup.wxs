<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>
  <!-- This gets automatically generated by the makefile running SubWCRev.exe on VersionNumberInclude.in.wxi -->
  <?include VersionNumberInclude.wxi ?>
  <Product
    UpgradeCode="409CCD06-15F2-4211-B3EE-3BA03265597F"
    Name='CryptSync'
    Id='*'
    Language='1033'
    Codepage='1252'
    Version='$(var.MajorVersion).$(var.MinorVersion).$(var.BuildVersion)'
    Manufacturer='Stefans Tools'>

    <Package Id='*' Keywords='Installer'
          Description="Stefans CryptSync"
          Comments='http://tools.tortoisesvn.net' Manufacturer='Stefans Tools'
          InstallerVersion='200' Languages='1033' Compressed='yes' SummaryCodepage='1252' />

    <Upgrade Id="409CCD06-15F2-4211-B3EE-3BA03265597F" >
      <!-- flag is set if the install will trigger an upgrade of an existing install -->
      <UpgradeVersion Property="PREVIOUSVERSIONSINSTALLED" Maximum="$(var.MajorVersion).$(var.MinorVersion).$(var.BuildVersion)" IncludeMaximum="no" />
    </Upgrade>

    <Media Id='1' Cabinet='CryptSync.cab' EmbedCab='yes' />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
    <Condition Message='This application only runs on Windows 2000 and later.'>VersionNT &gt;= 500</Condition>

    <Property Id="INSTALLDIR">
      <RegistrySearch Id="PreviousInstallLocationRegistrySearch" Root="HKLM" Key="Software\CryptSync" Name="installDir" Type="raw" />
    </Property>

    <Directory Id='TARGETDIR' Name='SourceDir'>
      <Directory Id='ProgramFilesFolder' Name='PFiles'>
        <Directory Id='INSTALLDIR' Name='CryptSync'>

          <Component Id='MainEXE' Guid='186BFEE2-AD6A-46A4-9928-45D243AEBF4C'>
            <File Id='CryptSync.EXE' Name='CryptSync.exe' DiskId='1' Source='../../release/win32/CryptSync.exe' Vital='yes' />
            <File Id='Z7Z.EXE' Name='7z.exe' DiskId='1' Source='../../tools/7z.exe' Vital='yes' />
            <File Id='Z7Z.DLL' Name='7z.dll' DiskId='1' Source='../../tools/7z.dll' Vital='yes' />
            <RegistryValue Root="HKLM" Key="Software\CryptSync" Name="installDir" Value='[INSTALLDIR]' Type="string" />
          </Component>

        </Directory>
        <Directory Id="ProgramMenuFolder" Name="Programs">
          <Directory Id="ProgramMenuDir" Name="CryptSync" />
        </Directory>
      </Directory>

    </Directory>
    <DirectoryRef Id="ProgramMenuDir">
      <Component Id="StartMenuShortCut" Guid='BE51529C-81C0-4F79-B163-FA577319D9B5'>
        <Shortcut Id="startMenuCryptSync" Directory="ProgramMenuDir" Name="CryptSync" Target="[INSTALLDIR]CryptSync.exe" Description="regular expression search" />
        <RemoveFolder Id="ProgramMenuDir" On="uninstall"/>
        <RegistryValue Root="HKCU" Key="Software\CryptSync" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <Feature Id='Complete' Title='CryptSync' Description='The complete package.'
          Display='expand' Level='1' ConfigurableDirectory='INSTALLDIR'>
      <Feature Id='MainEXE' Title='Program' Description='The main executable.' Level='1'>
        <ComponentRef Id='MainEXE' />
        <ComponentRef Id='StartMenuShortCut' />
      </Feature>
    </Feature>

    <UI>
      <UIRef Id="WixUI_InstallDir" />
      <!-- skip licence dialog -->
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="2">1</Publish>
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="2">1</Publish>

      <Publish Dialog="ExitDialog"
                  Control="Finish"
                  Event="DoAction"
                  Value="LaunchApplication">NOT Installed</Publish>
    </UI>
    <WixVariable Id="WixUIBannerBmp" Value="Banner.jpg" />
    <WixVariable Id="WixUIDialogBmp" Value="Dialog.jpg" />
    <Property Id="WixShellExecTarget" Value="[#CommitMonitor.EXE]" />
    <CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

    <InstallExecuteSequence>
      <AppSearch Sequence="1"></AppSearch>
      <LaunchConditions After="AppSearch" />
      <RemoveExistingProducts After="InstallValidate"><![CDATA[PREVIOUSVERSIONSINSTALLED]]></RemoveExistingProducts>
    </InstallExecuteSequence>

  </Product>
</Wix>
