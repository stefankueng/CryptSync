<?xml version="1.0" encoding="windows-1252"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <!-- This gets automatically generated by the makefile running SubWCRev.exe on VersionNumberInclude.in.wxi -->
  <?include VersionNumberInclude.wxi ?>
  <Product
    UpgradeCode="409CCD06-15F2-4211-B3EE-3BA03265597F"
    Name="CryptSync"
    Id="*"
    Language="1033"
    Codepage="1252"
    Version="$(var.MajorVersion).$(var.MinorVersion).$(var.BuildVersion)"
    Manufacturer="Stefans Tools">

    <Package Id="*"
          Description="Stefans CryptSync"
          Keywords="cloud, security, encryption"
          Comments="http://stefanstools.sourceforge.net" Manufacturer="Stefans Tools"
          InstallerVersion="200" Languages="1033" Compressed="yes" SummaryCodepage="1252" />

    <Upgrade Id="409CCD06-15F2-4211-B3EE-3BA03265597F" >
      <!-- flag is set if the install will trigger an upgrade of an existing install -->
      <UpgradeVersion Property="PREVIOUSVERSIONSINSTALLED" Maximum="$(var.MajorVersion).$(var.MinorVersion).$(var.BuildVersion)" IncludeMaximum="no" />
    </Upgrade>

    <Media Id="1" Cabinet="CryptSync.cab" EmbedCab="yes" CompressionLevel="high" />
    <Icon Id="CryptSyncIcon" SourceFile="..\CryptSync.ico" />
    <Property Id="ARPPRODUCTICON">CryptSyncIcon</Property>
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
    <Condition Message="This application only runs on Vista and later.">
      <![CDATA[Installed OR (VersionNT >= 600)]]>
    </Condition>

    <Property Id="INSTALLDIR">
      <RegistrySearch Id="PreviousInstallLocationRegistrySearch" Root="HKLM" Key="Software\CryptSync" Name="installDir" Type="raw" />
    </Property>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder" Name="PFiles">
        <Directory Id="INSTALLDIR" Name="CryptSync">

          <Component Id="CryptSync.exe" Guid="186BFEE2-AD6A-46A4-9928-45D243AEBF4C">
            <File Id="CryptSync.EXE" Name="CryptSync.exe" DiskId="1" Source="../../bin/release/win32/CryptSync.exe" Vital="yes" />
            <RegistryValue Root="HKLM" Key="Software\CryptSync" Name="installDir" Value='[INSTALLDIR]' Type="string" />
          </Component>
          <Component Id="ZipExe" Guid="334DA1F3-3A8E-4F79-B6F8-DB7B28CB5FBE">
            <File Id="Z7Z.EXE" Name="7z.exe" DiskId="1" Source="../../tools/win32/7z.exe" Vital="yes" />
            <File Id="Z7Z.DLL" Name="7z.dll" DiskId="1" Source="../../tools/win32/7z.dll" Vital="yes" />
          </Component>
          <Component Id="GPG" Guid="F80C3396-152B-475A-8341-77FA25241277">
            <File Id="GPG.EXE" Name="gpg.exe" DiskId="1" Source="../../tools/gpg.exe" Vital="yes" />
            <File Id="ICONV.DLL" Name="iconv.dll" DiskId="1" Source="../../tools/iconv.dll" Vital="yes" />
          </Component>

        </Directory>
        <Directory Id="ProgramMenuFolder" Name="Programs">
          <Directory Id="ProgramMenuDir" Name="CryptSync" />
        </Directory>
      </Directory>

    </Directory>
    <DirectoryRef Id="ProgramMenuDir">
      <Component Id="StartMenuShortCut" Guid="BE51529C-81C0-4F79-B163-FA577319D9B5">
        <Shortcut Id="startMenuCryptSync" Directory="ProgramMenuDir" Name="CryptSync" Target="[INSTALLDIR]CryptSync.exe" Description="A folder sync tool with encryption" />
        <RemoveFolder Id="ProgramMenuDir" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\CryptSync" Name="installed" Type="integer" Value="1" KeyPath="yes" />
        <IniFile Id="WebsiteUrl" Action="addLine" Name="Website.url" Directory="INSTALLDIR" Section="InternetShortcut" Key="URL" Value="http://stefanstools.sourceforge.net" />
        <Shortcut Id="WebsiteUrlShortCut" Directory="ProgramMenuDir" Name="Website" Target="[INSTALLDIR]Website.url" Description="Visit CryptSync's Website" />
      </Component>
    </DirectoryRef>

    <Feature Id="Complete" Title="CryptSync" Description="The complete package."
          Display="expand" Level="1" ConfigurableDirectory="INSTALLDIR">
      <Feature Id="MainEXE" Title="Program" Description="The main executable." Level="1">
        <ComponentRef Id="CryptSync.exe" />
        <ComponentRef Id="ZipExe" />
        <ComponentRef Id="GPG" />
        <ComponentRef Id="StartMenuShortCut" />
      </Feature>
    </Feature>

    <UI>
      <UIRef Id="WixUI_InstallDir" />
      <!-- skip licence dialog -->
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="2">1</Publish>
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="2">1</Publish>

      <Publish Dialog="ExitDialog"
                  Control="Finish"
                  Event="DoAction"
                  Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
    </UI>
    <WixVariable Id="WixUIBannerBmp" Value="Banner.jpg" />
    <WixVariable Id="WixUIDialogBmp" Value="Dialog.jpg" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch CryptSync" />
    <Property Id="WixShellExecTarget" Value="[#CryptSync.EXE]" />
    <CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

    <InstallExecuteSequence>
      <AppSearch Sequence="1"></AppSearch>
      <LaunchConditions After="AppSearch" />
      <RemoveExistingProducts After="InstallValidate"><![CDATA[PREVIOUSVERSIONSINSTALLED]]></RemoveExistingProducts>
    </InstallExecuteSequence>

  </Product>
</Wix>
